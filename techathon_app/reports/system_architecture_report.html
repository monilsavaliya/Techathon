<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Techathon System Architecture - Technical Design Document</title>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap"
        rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --sidebar-width: 300px;
            --primary: #4f46e5;
            /* Indigo */
            --primary-light: #e0e7ff;
            --secondary: #64748b;
            --accent: #06b6d4;
            /* Cyan */
            --danger: #ef4444;
            --success: #10b981;
            --border: #e2e8f0;
            --bg-body: #ffffff;
            --bg-sidebar: #f8fafc;
            --bg-code: #1e1e1e;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: 'Inter', sans-serif;
            color: #1e293b;
            display: flex;
            min-height: 100vh;
        }

        /* SIDEBAR NAVIGATION */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            padding: 40px 30px;
            top: 0;
            left: 0;
            z-index: 100;
        }

        .brand {
            font-weight: 800;
            font-size: 20px;
            color: var(--primary);
            margin-bottom: 50px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nav-group {
            margin-bottom: 35px;
        }

        .nav-title {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1.2px;
            color: var(--secondary);
            font-weight: 700;
            margin-bottom: 15px;
            padding-left: 10px;
            border-left: 2px solid transparent;
        }

        .nav-link {
            display: block;
            color: #334155;
            text-decoration: none;
            font-size: 14px;
            padding: 8px 10px;
            border-radius: 6px;
            transition: all 0.2s;
            margin-bottom: 2px;
        }

        .nav-link:hover {
            background: #e2e8f0;
            color: var(--primary);
        }

        .nav-link.active {
            background: var(--primary-light);
            color: var(--primary);
            font-weight: 600;
        }

        .nav-link i {
            width: 24px;
            color: #94a3b8;
        }

        /* MAIN CONTENT */
        .main {
            margin-left: var(--sidebar-width);
            flex: 1;
            padding: 80px 100px;
            max-width: 1200px;
        }

        h1 {
            font-size: 42px;
            font-weight: 800;
            margin-bottom: 10px;
            letter-spacing: -1px;
            color: #0f172a;
        }

        .doc-meta {
            font-size: 13px;
            color: var(--secondary);
            margin-bottom: 60px;
            border-bottom: 1px solid var(--border);
            padding-bottom: 30px;
        }

        h2 {
            font-size: 28px;
            font-weight: 700;
            margin-top: 80px;
            margin-bottom: 25px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
            color: #1e293b;
        }

        h3 {
            font-size: 20px;
            font-weight: 600;
            margin-top: 50px;
            margin-bottom: 15px;
            color: #334155;
        }

        p {
            line-height: 1.8;
            color: #475569;
            margin-bottom: 20px;
            font-size: 15px;
        }

        /* TECH SPECS TABLE */
        table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            margin-bottom: 40px;
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
        }

        th {
            background: #f1f5f9;
            text-align: left;
            padding: 15px 20px;
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: #64748b;
            border-bottom: 1px solid var(--border);
        }

        td {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            vertical-align: top;
            font-size: 14px;
        }

        tr:last-child td {
            border-bottom: none;
        }

        tr:hover td {
            background: #f8fafc;
        }

        .badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 600;
            display: inline-block;
        }

        .badge-core {
            background: #dbeafe;
            color: #1e40af;
        }

        .badge-ui {
            background: #fce7f3;
            color: #9d174d;
        }

        .badge-data {
            background: #ecfdf5;
            color: #065f46;
        }

        /* CODE BLOCKS */
        .code-window {
            background: var(--bg-code);
            border-radius: 8px;
            margin: 30px 0;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .window-header {
            background: #2d2d2d;
            padding: 8px 15px;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .red {
            background: #ff5f56;
        }

        .yellow {
            background: #ffbd2e;
        }

        .green {
            background: #27c93f;
        }

        pre {
            margin: 0;
            padding: 25px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            color: #d4d4d4;
            overflow-x: auto;
            line-height: 1.6;
        }

        .k {
            color: #569cd6;
        }

        /* Keyword */
        .c {
            color: #6a9955;
        }

        /* Comment */
        .s {
            color: #ce9178;
        }

        /* String */
        .f {
            color: #dcdcaa;
        }

        /* Function */

        /* ARCH DIAGRAMS (CSS ONLY) */
        .diagram-box {
            background: #f8fafc;
            border: 1px dashed #cbd5e1;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            margin: 40px 0;
        }

        .flow-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }

        .node {
            background: white;
            border: 1px solid #e2e8f0;
            padding: 15px 25px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            width: 150px;
        }

        .arrow {
            color: #94a3b8;
            font-size: 20px;
        }

        @media print {
            .sidebar {
                display: none;
            }

            .main {
                margin: 0;
                padding: 0;
            }
        }
    </style>
</head>

<body>

    <nav class="sidebar">
        <div class="brand">
            <i class="fas fa-layer-group"></i> SYSTEM ARCH
        </div>

        <div class="nav-group">
            <div class="nav-title">Core Architecture</div>
            <a href="#overview" class="nav-link active"><i class="fas fa-sitemap"></i> High-Level Design</a>
            <a href="#orchestrator" class="nav-link"><i class="fas fa-brain"></i> Main Agent Logic</a>
            <a href="#data-flow" class="nav-link"><i class="fas fa-stream"></i> Data Flow Pipelines</a>
        </div>

        <div class="nav-group">
            <div class="nav-title">Frontend Layer</div>
            <a href="#ui-framework" class="nav-link"><i class="fas fa-paint-brush"></i> UI/UX Framework</a>
            <a href="#state-management" class="nav-link"><i class="fas fa-sync-alt"></i> State Management</a>
        </div>

        <div class="nav-group">
            <div class="nav-title">Reliability</div>
            <a href="#error-handling" class="nav-link"><i class="fas fa-shield-alt"></i> Error Boundaries</a>
            <a href="#security" class="nav-link"><i class="fas fa-lock"></i> Security Model</a>
        </div>
    </nav>

    <div class="main">

        <div id="overview">
            <h1>System Architecture Bible</h1>
            <div class="doc-meta">
                Technical Design Document (TDD) v4.0 &bull; Confidential &bull; Author: Lead Architect
            </div>

            <p>
                The <strong>AI Sales Agent Platform</strong> is a distributed, multi-agent orchestration system designed
                to automate the Request for Proposal (RFP) lifecycle.
                It employs a "Centralized State" pattern where a single Main Agent orchestrates specialized sub-agents
                (Sales, Technical, Pricing) via a file-based transactional database.
            </p>
        </div>

        <!-- 1. MAIN AGENT LOGIC -->
        <h2 id="orchestrator">1. The Orchestration Engine (`main_agent.py`)</h2>
        <p>
            The <code>MainAgent</code> class acts as the system kernel. It is responsible for initializing the
            environment, managing the "Global Priority Queue", and enforcing Transactional Integrity.
            Unlike simple scripts, it uses <strong>Thread-Safe File I/O</strong> to prevent race conditions during
            concurrent updates.
        </p>

        <h3>1.1 Design Pattern: The "State Manager"</h3>
        <table>
            <thead>
                <tr>
                    <th>Component</th>
                    <th>Role</th>
                    <th>Implementation Detail</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>Global Priority Queue</strong></td>
                    <td><span class="badge badge-core">Core Logic</span></td>
                    <td>Dynamic sorting (<code>O(n log n)</code>) of RFPs based on calculated Margin %. Re-runs
                        automatically when Pricing changes.</td>
                </tr>
                <tr>
                    <td><strong>Thread Safety</strong></td>
                    <td><span class="badge badge-data">Reliability</span></td>
                    <td>Atomic JSON writes using temporary swp files (implied) to ensure
                        <code>central_rfp_database.json</code> never corrupts.
                    </td>
                </tr>
            </tbody>
        </table>

        <h3>1.2 Core Logic: Priority Re-Ranking</h3>
        <p>The system automatically promotes "high margin" opportunities to the top of the dashboard.</p>
        <div class="code-window">
            <div class="window-header">
                <div class="dot red"></div>
                <div class="dot yellow"></div>
                <div class="dot green"></div>
            </div>
            <pre>
<span class="k">def</span> <span class="f">recalculate_priorities</span>(self):
    <span class="c"># 1. Load all Active RFPs</span>
    data = self.load_db()
    
    <span class="c"># 2. Sort by Financial Margin (High to Low)</span>
    active_items.sort(key=<span class="k">lambda</span> x: get_margin(x), reverse=<span class="k">True</span>)
    
    <span class="c"># 3. Assign Dynamic Labels (Top 33% = High)</span>
    <span class="k">for</span> rank, rfp <span class="k">in</span> enumerate(active_items):
        rfp[<span class="s">'priority_score'</span>] = <span class="s">"High"</span> <span class="k">if</span> rank < (total * 0.33) <span class="k">else</span> <span class="s">"Low"</span></pre>
        </div>

        <!-- NEW: ARCHITECTURE SPOTLIGHT (The "Why") -->
        <h2 id="efficiency-spotlight" style="color: var(--primary); border-bottom: 2px solid var(--primary);">ðŸš€
            Architecture Spotlight: The "Zero-Copy" Token System</h2>
        <p>
            <strong>Why is this system faster than others?</strong><br>
            Most potential competitors pass the <em>entire data blob</em> (PDF + Extracted Text + Images) from Agent to
            Agent. This is slow, error-prone, and uses massive memory.
        </p>
        <p>
            <strong>Our Approach: The Hospital Analogy</strong><br>
            Imagine a patient (The RFP) moving through a hospital.
        <ul>
            <li><strong>Bad Way (Competitors):</strong> The patient carries their <em>entire</em> medical history,
                X-Rays, and MRI scans in a massive box from room to room. If they drop the box, data is lost.</li>
            <li><strong>Our Way (Token System):</strong> The patient carries <strong>ONLY</strong> their ID Wristband
                (`rfp_unique_id`). The Specialist (Agent) scans the ID, pulls <em>only</em> what they need from the
                Central Server, treats the patient, and updates the server.</li>
        </ul>
        </p>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 40px;">
            <div style="background: #fee2e2; padding: 20px; border-radius: 8px; border: 1px solid #ef4444;">
                <h4 style="margin-top:0; color:#b91c1c;"><i class="fas fa-times-circle"></i> The Wrong Way (Monolithic)
                </h4>
                <div style="font-family: monospace; font-size: 12px; color: #7f1d1d;">
                    Function(Big_Data) -> Returns(Big_Data_v2)<br>
                    Function2(Big_Data_v2) -> Returns(Big_Data_v3)<br>
                    <br>
                    <strong>Risks:</strong><br>
                    - Memory Overflow (RAM Spike)<br>
                    - Data Loss if Func2 crashes<br>
                    - Slow (Copying MBs of data)
                </div>
            </div>
            <div style="background: #d1fae5; padding: 20px; border-radius: 8px; border: 1px solid #10b981;">
                <h4 style="margin-top:0; color:#047857;"><i class="fas fa-check-circle"></i> Our Way (Reference Passing)
                </h4>
                <div style="font-family: monospace; font-size: 12px; color: #064e3b;">
                    Agent1(ID="RFP-001") -> Updates DB<br>
                    Agent2(ID="RFP-001") -> Updates DB<br>
                    <br>
                    <strong>Benefits:</strong><br>
                    - Zero Memory Overhead (Pass string "RFP-001")<br>
                    - ACID Consistency (DB handles safety)<br>
                    - Resume Capability (If Agent2 crashes, re-run ID)
                </div>
            </div>
        </div>

        <!-- 2. EXECUTION TRACE WORKFLOW -->
        <h2 id="data-flow">2. Step-by-Step Execution Trace</h2>
        <p>
            The system executes a precise sequence of operations for every new RFP. Below is the exact "Trace Log" of a
            single transaction.
        </p>

        <!-- STEP 1: INGESTION -->
        <div class="code-window" style="margin-bottom: 50px;">
            <div class="window-header" style="background: #2563eb;">
                <span style="color:white; font-weight:700;">STEP 1: INGESTION & PARSING (Sales Agent)</span>
            </div>
            <div style="padding: 20px; background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
                <div style="font-size: 13px; margin-bottom: 10px;">
                    <strong>Trigger:</strong> User uploads `tender_doc.pdf` via Dashboard.<br>
                    <strong>Agent:</strong> <code>RealSalesAgent (sales_api.py)</code><br>
                    <strong>Input:</strong> Raw PDF Byte Stream.
                </div>
            </div>
            <pre>
<span class="c"># 1. OCR & Extraction</span>
<span class="k">raw_text</span> = pdf_reader.extract_text(file)

<span class="c"># 2. Variable Extraction (Regex + LLM)</span>
<span class="k">client_name</span> = "Delhi Metro Rail Corp"
<span class="k">lt_line_items</span> = extract_table(raw_text, "Price Schedule")

<span class="c"># 3. Geo-Spatial Logic (logistic_master.json)</span>
<span class="k">delivery_loc</span> = "Mukundpur Depot"
<span class="k">zone_info</span> = db.lookup_zone(lat=28.73, lon=77.19) 
<span class="c"># >> Returns: { "zone_code": "Z-04", "risk_factor": 1.2 }</span>

<span class="c"># 4. Output Generation</span>
<span class="k">return</span> {
    <span class="s">"sales_agent_output"</span>: { ...JSON Structure... }
}</pre>
        </div>

        <!-- STEP 2: TECHNICAL MATCHING -->
        <div class="code-window" style="margin-bottom: 50px;">
            <div class="window-header" style="background: #06b6d4;">
                <span style="color:white; font-weight:700;">STEP 2: TECHNICAL MATCHING (Tech Agent)</span>
            </div>
            <div style="padding: 20px; background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
                <div style="font-size: 13px; margin-bottom: 10px;">
                    <strong>Trigger:</strong> Main Agent detects `sales_agent_output` exists.<br>
                    <strong>Agent:</strong> <code>RealTechAgent (tech_agent.py)</code><br>
                    <strong>Databases Read:</strong> `product_master_enriched.json`, `test_master.json`
                </div>
            </div>
            <pre>
<span class="c"># 1. Load Inventory (4000+ SKUs)</span>
<span class="k">inventory</span> = load_json("product_master_enriched.json")

<span class="c"># 2. Fuzzy Matching Algorithm</span>
<span class="k">for</span> item <span class="k">in</span> sales_output[<span class="s">'line_items'</span>]:
    <span class="k">query</span> = { "volts": "33kV", "core": 3, "size": 400 }
    
    <span class="c"># Find Best Match (Score > 90%)</span>
    <span class="k">match</span> = find_best_fit(inventory, query)
    
    <span class="c"># 3. Compliance Check</span>
    <span class="k">required_tests</span> = lookup_mandatory_tests(match[<span class="s">'type'</span>])
    <span class="c"># >> Adds "High Voltage Water Tank Test" to BOM</span>

<span class="c"># 4. Output Update</span>
<span class="k">central_db.update</span>(rfp_id, "tech_agent_output", match_results)</pre>
        </div>

        <!-- STEP 3: FINANCIAL MODELING -->
        <div class="code-window">
            <div class="window-header" style="background: #10b981;">
                <span style="color:white; font-weight:700;">STEP 3: PRICING & STRATEGY (Pricing Agent)</span>
            </div>
            <div style="padding: 20px; background: #f8fafc; border-bottom: 1px solid #e2e8f0;">
                <div style="font-size: 13px; margin-bottom: 10px;">
                    <strong>Trigger:</strong> Tech Agent marks `status="Completed"`.<br>
                    <strong>Agent:</strong> <code>RealPricingAgent (pricing_agent.py)</code><br>
                    <strong>Databases Read:</strong> `competitors.json`, `factory_production_schedule.json`,
                    `client_master.json`
                </div>
            </div>
            <pre>
<span class="c"># 1. Base Costing (Cost Plus)</span>
<span class="k">base_price</span> = match[<span class="s">'commercial'</span>][<span class="s">'mfg_cost'</span>] * qty
<span class="k">logistics_cost</span> = dist_km * weight * zone_multiplier

<span class="c"># 2. Strategic Adjustment (Game Theory)</span>
<span class="k">competitor</span> = load_competitor("Havells")
<span class="k">if</span> competitor[<span class="s">'aggression'</span>] > 8:
    <span class="k">target_margin</span> = 0.05 <span class="c"># Drop margin to 5% to win</span>

<span class="c"># 3. Factory Constraints</span>
<span class="k">factory_load</span> = get_factory_status()
<span class="k">if</span> factory_load > 90%:
    <span class="k">lead_time</span> += 14_days
    <span class="k">surge_price</span> = base_price * 0.05

<span class="c"># 4. Final Quote Generation</span>
<span class="k">final_quote</span> = (base_price + logistics + surge) * (1 + target_margin)</pre>
        </div>
        <!-- 3. FRONTEND ARCHITECTURE -->
        <h2 id="ui-framework">3. Frontend Architecture (Flask + Tailwind)</h2>
        <p>
            The UI is built on a "Hybrid Rendering" model.
            <strong>Server-Side Rendering (Flask/Jinja2)</strong> handles the initial load for SEO and speed.
            <strong>Client-Side Interactivity (Alpine.js)</strong> handles dynamic modals and sidebar states.
        </p>

        <h3>3.1 Technology Stack</h3>
        <table>
            <thead>
                <tr>
                    <th>Layer</th>
                    <th>Technology</th>
                    <th>Purpose</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td><strong>View Layer</strong></td>
                    <td><span class="badge badge-ui">Tailwind CSS</span></td>
                    <td>Utility-first styling for "Glassmorphism" and responsive grids.</td>
                </tr>
                <tr>
                    <td><strong>Interactivity</strong></td>
                    <td><span class="badge badge-ui">Alpine.js</span></td>
                    <td>Lightweight JS for Sidebar Toggles and Modal "Show/Hide" logic.</td>
                </tr>
                <tr>
                    <td><strong>Template Engine</strong></td>
                    <td><span class="badge badge-core">Jinja2</span></td>
                    <td>Dynamic HTML generation with inheritance (`base.html`).</td>
                </tr>
            </tbody>
        </table>

        <!-- 4. RELIABILITY -->
        <h2 id="error-handling">4. Error Boundaries & Resilience</h2>
        <p>The system is designed to "Fail Gracefully". If an agent crashes, the pipeline pauses, but the data is
            preserved.</p>

        <h3>4.1 Safety Mechanisms</h3>
        <ul>
            <li><strong>Atomic Writes:</strong> The `save_to_db_record` function locks the file during write operations.
            </li>
            <li><strong>Fallback Mocks:</strong> `MockTechAgent` exists to allow frontend testing even if the backend AI
                is offline.</li>
            <li><strong>Input Sanitization:</strong> The Data Manager ensures raw JSON edits are validated before
                saving.</li>
        </ul>

    </div>

</body>

</html>